<!-- user-form-drawer.component.html -->

<!-- Backdrop -->
<div
  *ngIf="isOpen"
  class="fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity duration-300"
  (click)="onClose()"
></div>

<!-- Drawer (Desktop: Right side, Mobile: Centered) -->
<div
  *ngIf="isOpen"
  class="fixed z-50 bg-white shadow-2xl transition-all duration-300 ease-in-out overflow-hidden
         md:top-0 md:right-0 md:h-full md:w-[600px]
         max-md:top-1/2 max-md:left-1/2 max-md:transform max-md:-translate-x-1/2 max-md:-translate-y-1/2
         max-md:rounded-lg max-md:w-[95%] max-md:max-w-[500px] max-md:max-h-[90vh]"
>
  <!-- Header -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between">
    <h2 class="text-xl font-bold text-white">
      {{ mode === 'create' ? 'Create New User' : 'Edit User' }}
    </h2>
    <button
      (click)="onClose()"
      class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-1 transition-colors"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Form Content (Scrollable) -->
  <div class="overflow-y-auto p-6" style="max-height: calc(100vh - 140px);">
    <form>
      <!-- Basic Information Section -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
          Basic Information
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- User ID -->
          <app-form-input
            [(ngModel)]="formData.userId"
            name="userId"
            label="User ID"
            placeholder="Enter user ID"
            width="full"
            [required]="true"
            [disabled]="mode === 'edit'"
            [error]="!!errors['userId']"
            [errorMessage]="errors['userId']"
          ></app-form-input>

          <!-- Username -->
          <app-form-input
            [(ngModel)]="formData.username"
            name="username"
            label="Username"
            placeholder="Enter username"
            width="full"
            [required]="true"
            [error]="!!errors['username']"
            [errorMessage]="errors['username']"
          ></app-form-input>

          <!-- Display Name -->
          <app-form-input
            [(ngModel)]="formData.displayName"
            name="displayName"
            label="Display Name"
            placeholder="Enter display name"
            width="full"
            [required]="true"
            [error]="!!errors['displayName']"
            [errorMessage]="errors['displayName']"
          ></app-form-input>

          <!-- Full Name -->
          <app-form-input
            [(ngModel)]="formData.fullName"
            name="fullName"
            label="Full Name"
            placeholder="Enter full name"
            width="full"
            [required]="true"
            [error]="!!errors['fullName']"
            [errorMessage]="errors['fullName']"
          ></app-form-input>
        </div>

        <!-- Position (Full Width) -->
        <app-form-input
          [(ngModel)]="formData.position"
          name="position"
          label="Position"
          placeholder="Enter position"
          [required]="true"
          [error]="!!errors['position']"
          [errorMessage]="errors['position']"
        ></app-form-input>

        <!-- Status Toggle -->
        <app-form-toggle
          [(ngModel)]="formData.status"
          name="status"
          label="Status"
          activeLabel="Active"
          inactiveLabel="Inactive"
          activeValue="active"
          inactiveValue="inactive"
          [required]="true"
        ></app-form-toggle>
      </div>

      <!-- Role & Department Section -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
          Role & Department
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Role Dropdown -->
          <div class="form-group mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Role
              <span class="text-red-500 ml-1">*</span>
            </label>
            <p-select
              [(ngModel)]="formData.role"
              name="role"
              [options]="roleOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select role"
              [filter]="true"
              filterBy="label"
              [showClear]="true"
              styleClass="w-full"
              [class.border-red-500]="!!errors['role']"
            ></p-select>
            <p *ngIf="errors['role']" class="text-red-500 text-xs mt-1">
              {{ errors['role'] }}
            </p>
          </div>

          <!-- Department Dropdown -->
          <div class="form-group mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Department
              <span class="text-red-500 ml-1">*</span>
            </label>
            <p-select
              [(ngModel)]="formData.department"
              name="department"
              [options]="departmentOptions"
              optionLabel="label"
              optionValue="value"
              placeholder="Select department"
              [filter]="true"
              filterBy="label"
              [showClear]="true"
              styleClass="w-full"
              [class.border-red-500]="!!errors['department']"
            ></p-select>
            <p *ngIf="errors['department']" class="text-red-500 text-xs mt-1">
              {{ errors['department'] }}
            </p>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
          Settings
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Max Sessions -->
          <app-form-input
            [(ngModel)]="formData.maxSessions"
            name="maxSessions"
            type="number"
            label="Max Sessions (Days)"
            placeholder="90"
            width="full"
            [required]="true"
            hint="Maximum days before session expires"
          ></app-form-input>

          <!-- Warning Days -->
          <app-form-input
            [(ngModel)]="formData.warningDays"
            name="warningDays"
            type="number"
            label="Warning Days"
            placeholder="0"
            width="full"
            [required]="true"
            hint="Days before expiry to show warning"
          ></app-form-input>
        </div>

        <!-- Email -->
        <app-form-input
          [(ngModel)]="formData.email"
          name="email"
          type="email"
          label="Email"
          placeholder="user@example.com"
          [error]="!!errors['email']"
          [errorMessage]="errors['email']"
          hint="Optional: Enter email for notifications"
        ></app-form-input>

        <!-- Avatar Upload -->
        <app-form-file-upload
          [(ngModel)]="formData.avatar"
          name="avatar"
          label="Avatar"
          accept="image/*"
          [maxSizeMB]="5"
          hint="Max size: 5MB. Supported: JPG, PNG, GIF"
        ></app-form-file-upload>

        <!-- Send Email Checkbox -->
        <div class="flex items-center mb-4">
          <input
            type="checkbox"
            [(ngModel)]="formData.sendEmail"
            name="sendEmail"
            id="sendEmail"
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <label for="sendEmail" class="ml-2 text-sm text-gray-700">
            Send welcome email to user
          </label>
        </div>
      </div>

      <!-- Password Section (only show for create mode or if editing) -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">
          {{ mode === 'create' ? 'Set Password' : 'Change Password (Optional)' }}
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Password -->
          <app-form-input
            [(ngModel)]="formData.password"
            name="password"
            type="password"
            label="Password"
            placeholder="Enter password"
            width="full"
            [required]="mode === 'create'"
            [error]="!!errors['password']"
            [errorMessage]="errors['password']"
            hint="Minimum 6 characters"
          ></app-form-input>

          <!-- Confirm Password -->
          <app-form-input
            [(ngModel)]="formData.confirmPassword"
            name="confirmPassword"
            type="password"
            label="Confirm Password"
            placeholder="Re-enter password"
            width="full"
            [required]="mode === 'create'"
            [error]="!!errors['confirmPassword']"
            [errorMessage]="errors['confirmPassword']"
          ></app-form-input>
        </div>
      </div>

    </form>
  </div>

  <!-- Footer Actions -->
  <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex justify-end gap-3">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      [outlined]="true"
      severity="secondary"
      (onClick)="onClose()"
      [disabled]="isSubmitting"
    ></p-button>

    <p-button
      [label]="mode === 'create' ? 'Create User' : 'Save Changes'"
      icon="pi pi-check"
      severity="primary"
      (onClick)="onSubmit()"
      [loading]="isSubmitting"
    ></p-button>
  </div>
</div>

<!-- Warning Modal -->
<app-warning-modal
  [isOpen]="showWarning"
  title="Validation Error"
  [message]="warningMessage"
  buttonText="OK"
  (onClose)="closeWarning()"
></app-warning-modal>
